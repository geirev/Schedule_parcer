## Schedule_parser

Simple parser used to update Eclipse schedule files with perturbed rates.

The parser uses rates generated by ERT_ratesamp available from https://github.com/geirev/ERT_ratesamp

## User instructions

compile the file src/parser.c
```bash
cd src
cc.sh
```

Define the ERT job
```bash
./jobs/SCHED_PARSER.txt
```
containing
```bash
EXECUTABLE /home/AD.NORCERESEARCH.NO/geev/Dropbox/Programs/Schedule_parser/src/schedule_parserC
ARGLIST  <INPUT_FILE> <OUTPUT_FILE> <WELLS_FILE> <PERT_FILE>
TARGET_FILE <OUTPUT_FILE>
```

In config.ert include the following:
```bash
GEN_KW CONTROL templates/control.tmpl control.dat parameters/control.def INIT_FILES:../Prior/control/CONTROL_%d
```
This statement includes the perturbation controls as additional state variables in ERT.

If we run 100 realizations, it is assumed that the files, e.g., generated by https://github.com/geirev/ERT_ratesamp, exists
```bash
   ../Prior/control/CONTROL_0
   ...
   ../Prior/control/CONTROL_99
```
These files contain the time series for OPR, WPR and GPR perturbations for all wells stored as
```bash
OP_1_WOPR_1 -175.29
OP_1_WOPR_2 -76.816
OP_1_WOPR_3 37.55
OP_1_WOPR_4 158.35
OP_1_WOPR_5 272.23
OP_1_WOPR_6 300.31
OP_1_WOPR_7 284.02
OP_1_WOPR_8 327.57
OP_1_WOPR_9 431.95
OP_1_WOPR_10 529.34
...
```

ERT will output the correct control.dat file in each simulation catalog according to the template in
templates/control.tmpl:
```bash
OP_1 WOPR 1 <OP_1_WOPR_1>
OP_1 WOPR 2 <OP_1_WOPR_2>
OP_1 WOPR 3 <OP_1_WOPR_3>
OP_1 WOPR 4 <OP_1_WOPR_4>
OP_1 WOPR 5 <OP_1_WOPR_5>
OP_1 WOPR 6 <OP_1_WOPR_6>
OP_1 WOPR 7 <OP_1_WOPR_7>
OP_1 WOPR 8 <OP_1_WOPR_8>
OP_1 WOPR 9 <OP_1_WOPR_9>
OP_1 WOPR 10 <OP_1_WOPR_10>
...
```
which implies that the ert outputted control.dat file will look like
```bash
OP_1 WOPR 1 -175.29
OP_1 WOPR 2 -76.816
OP_1 WOPR 3 37.55
OP_1 WOPR 4 158.35
OP_1 WOPR 5 272.23
OP_1 WOPR 6 300.31
OP_1 WOPR 7 284.02
OP_1 WOPR 8 327.57
OP_1 WOPR 9 431.95
OP_1 WOPR 10 529.34
```
Note that you also need the file parameters/control.def although it is not used when you specify explicit input files
```bash
OP_1_WOPR_1 NORMAL 0.0 1.0
OP_1_WOPR_2 NORMAL 0.0 1.0
OP_1_WOPR_3 NORMAL 0.0 1.0
OP_1_WOPR_4 NORMAL 0.0 1.0
OP_1_WOPR_5 NORMAL 0.0 1.0
OP_1_WOPR_6 NORMAL 0.0 1.0
OP_1_WOPR_7 NORMAL 0.0 1.0
OP_1_WOPR_8 NORMAL 0.0 1.0
```


Next the parser will add these perturbations to the rates in the schedule file using the SCHED_PARSER job
```bash
INSTALL_JOB SCHED_PARSER jobs/SCHED_PARSER.txt

FORWARD_MODEL SCHED_PARSER( <INPUT_FILE>=<ECLINCLUDE>/history.sch,
                            <OUTPUT_FILE>=<RUNPATH>/history.sch,
                            <WELLS_FILE>=<ERTDIR>/control.txt,
                            <PERT_FILE>=<RUNPATH>/control.dat)
```

The control.txt file lists the wells, the rates, and the number of dates keywords, and it is of the form
```bash
OP_1 OPR 36
OP_1 WPR 36
OP_1 GPR 36
OP_2 OPR 36
OP_2 WPR 36
OP_2 GPR 36
OP_3 OPR 36
OP_3 WPR 36
OP_3 GPR 36
OP_4 OPR 36
OP_4 WPR 36
OP_4 GPR 36
OP_5 OPR 36
OP_5 WPR 36
OP_5 GPR 36
```

The schedule parser will update the historical rates in the schedule file in each rundir as
(update with correct perturbations)
```bash
WCONHIST
--OP_1  OPEN RESV   2368.110   6363.860     433652 /
  OP_1  OPEN RESV   2317.958   7759.410     519146 /
--OP_2  OPEN RESV   3123.930   2040.650     561157 /
  OP_2  OPEN RESV   3025.104   2118.438     545151 /
--OP_3  OPEN RESV   5348.270    693.983     663105 /
  OP_3  OPEN RESV   5179.553    579.148     832945 /
--OP_4  OPEN RESV   2023.780   4277.060     333931 /
  OP_4  OPEN RESV   2212.307   3919.693     366978 /
--OP_5  OPEN RESV   4293.840     11.398     451352 /
  OP_5  OPEN RESV   4736.552      9.365     515684 /
/
```


## Summary
Each realization runs with perturbed rates representing the errors in the rates.

As ERT includes the perturbations as a parameter they also get updated in the analysis scheme.
Thus, in subsequent iterations the realizations are forced with updated rates.
